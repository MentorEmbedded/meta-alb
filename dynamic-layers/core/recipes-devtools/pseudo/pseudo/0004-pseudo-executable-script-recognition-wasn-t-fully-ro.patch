From 86eb0c11236a04f669b9aad8919f841ebba9015f Mon Sep 17 00:00:00 2001
From: Heinz Wrobel <Heinz.Wrobel@nxp.com>
Date: Tue, 19 Jan 2021 18:03:31 +0100
Subject: [PATCH 4/4] pseudo: executable script recognition wasn't fully robust

Turns out that a pathological file could have confused the script
recognition. Now the check is still a bit silly but at least robust.

Signed-off-by: Heinz Wrobel <Heinz.Wrobel@nxp.com>
Signed-off-by: Ionut Vicovan <Ionut.Vicovan@nxp.com>
---
 pseudo_client.c | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/pseudo_client.c b/pseudo_client.c
index df24f89..f5b60cd 100644
--- a/pseudo_client.c
+++ b/pseudo_client.c
@@ -2336,9 +2336,11 @@ static int exec_chroot_scriptcheck(const char **filenamep, char * const**argvp,
 	int splitargs = 0;
 	int extraargc = 0;
 	int changeargv0 = 0;
+	ssize_t contentsize = 0;
 	char *s;
 
-	foundscript = isexecutable(chrootfile, &scriptcheck[0], sizeof(scriptcheck));
+	contentsize = isexecutable(chrootfile, &scriptcheck[0], sizeof(scriptcheck));
+	foundscript = (contentsize > 3);
 	if (foundscript) {
 		pseudo_debug(PDBGF_CLIENT, "exec path chroot checking for script in %s (argv[0]='%s')\n", chrootfile, (*argvp)[0]);
 		foundscript = 0;
@@ -2348,8 +2350,8 @@ static int exec_chroot_scriptcheck(const char **filenamep, char * const**argvp,
 			/* parse out the interpreter and arg as
 			 * the kernel does it in binfmt_script.c
 			 */
-            scriptcheck[sizeof(scriptcheck) - 1] = '\0';
-			s = strchr(scriptcheck, '\n');
+			scriptcheck[sizeof(scriptcheck) - 1] = '\0';
+			s = strchr(&scriptcheck[2], '\n');
 			if (s)
 				*s = 0;
 			s = &scriptcheck[2];
-- 
2.17.1

